<% layout('layouts/boilerplate') %>

  <div class="card mx-auto my-4" style="max-width: 40rem; border-radius: 1rem; overflow: hidden;">
    <!-- Listing Title -->
    <div class="text-black mb-2">
      <h3 class="m-0 text-3xl">
        <%= listing.title %>
      </h3>
    </div>

    <!-- Listing Image -->
    <% const imgUrl=listing && listing.image && listing.image.url && listing.image.url.trim() ? listing.image.url
      : '/images/default.jpg' ; %>
      <img src="<%= imgUrl %>" class="card-img-top" alt="Listing Image" style="height: 20rem; object-fit: cover;">

      <!-- Listing Details -->
      <div class="card-body">
        <p class="card-text"><strong>Owned by:</strong>
          <i>
            <%= listing.owner.username %>
          </i>
        </p>
        <p class="card-text"><strong>Description:</strong>
          <%= listing.description || 'N/A' %>
        </p>
        <p class="card-text"><strong>Price:</strong>
          <%= (listing.price !==undefined && listing.price !==null) ? '₹' +
            Number(listing.price).toLocaleString('en-IN') : 'N/A' %>
        </p>
        <p class="card-text"><strong>Location:</strong>
          <%= listing.location || 'N/A' %>
        </p>
        <p class="card-text"><strong>Country:</strong>
          <%= listing.country || 'N/A' %>
        </p>

        <% if(currUser && listing.owner._id.equals(currUser._id)) { %>
          <div class="mt-3 d-flex justify-content-between">
            <a href="/listings/<%= listing._id %>/edit" class="btn btn-warning">Edit Listing</a>
            <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE"
              onsubmit="return confirm('Are you sure you want to delete this listing?');">
              <button class="btn btn-danger">Delete Listing</button>
            </form>
          </div>
          <% } %>

            <hr>

            Leave a Review
            <% if(currUser) { %>
              <h4>Leave a Review</h4>
              <form action="/listings/<%= listing._id %>/reviews" method="POST" class="mb-5 needs-validation"
                novalidate>


                <!-- ⭐ Star Rating Section -->
                <div class="mb-3">
                  <label class="form-label d-block">Rating:</label>
                  <fieldset class="starability-slot" style="font-size:1.5rem;">
                    <!-- Hidden default unselected option -->
                    <input type="radio" id="noRate" name="review[rating]" value="" checked hidden>

                    <input type="radio" id="rate5" name="review[rating]" value="5" />
                    <label for="rate5" title="Amazing!">5 stars</label>

                    <input type="radio" id="rate4" name="review[rating]" value="4" />
                    <label for="rate4" title="Very good">4 stars</label>

                    <input type="radio" id="rate3" name="review[rating]" value="3" />
                    <label for="rate3" title="Average">3 stars</label>

                    <input type="radio" id="rate2" name="review[rating]" value="2" />
                    <label for="rate2" title="Not good">2 stars</label>

                    <input type="radio" id="rate1" name="review[rating]" value="1" />
                    <label for="rate1" title="Terrible">1 star</label>
                  </fieldset>
                </div>


                <div class="mb-3">
                  <label for="comment" class="form-label">Comment</label>
                  <textarea class="form-control" name="review[comment]" id="comment" cols="30" rows="4"
                    placeholder="Write your comment here..." required></textarea>
                  <div class="invalid-feedback">Please add a comment for your review.</div>
                </div>
                <button type="submit" class="btn btn-primary">Submit Review</button>
              </form>
              <% } %>

                <hr>

                <h4>All Reviews</h4>

                <div class="reviews-wrapper">
                  <div class="reviews-container row row-cols-1 row-cols-md-2 g-4 ">
                    <% for (let review of listing.reviews) { %>
                      <div class="col review-card flex-shrink-0">
                        <div class="card mb-3 shadow-lg border border-secondary rounded-3 h-100">
                          <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                              <h5 class="mb-0 fw-bold text-black">
                                <%= review.author ? review.author.username : review.username %>
                              </h5>
                              <small class="text-muted">
                                <%= new Date(review.createdAt).toLocaleDateString('en-IN', { day: 'numeric' ,
                                  month: 'short' , year: 'numeric' }) %>
                              </small>
                            </div>

                            <div class="starability-result" data-rating="<%= review.rating %>"></div>
                            <p class="card-text mt-2">
                              <%= review.comment %>
                            </p>

                            <% if (currUser && review.author && review.author._id.equals(currUser._id)) { %>
                              <form method="POST"
                                action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE"
                                onsubmit="return confirm('Are you sure you want to delete this review?');">
                                <button class="btn btn-sm btn-danger mt-2">Delete</button>
                              </form>
                              <% } %>
                          </div>
                        </div>
                      </div>
                      <% } %>
                  </div>
                </div>



                <!-- ✅ Bootstrap Validation Script -->
                <script>
                  (() => {
                    'use strict'
                    const forms = document.querySelectorAll('.needs-validation')
                    Array.from(forms).forEach(form => {
                      form.addEventListener('submit', event => {
                        if (!form.checkValidity()) {
                          event.preventDefault()
                          event.stopPropagation()
                        }
                        form.classList.add('was-validated')
                      }, false)
                    })
                  })()
                </script>
         
                <hr>
                       <h4>Where you’ll be</h4>
                <!-- Map Section (on top) -->
                <div id="map" style="height: 400px; width: 100%; border-radius: 1rem; margin-bottom: 10px;"></div>

                <hr>
                <!-- Leaflet.js CSS & JS -->
                <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
                <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

                <script>
                  // Map Initialization
                  const lat = ("<%= listing.lat != null ? listing.lat : 20.5937 %>");
                  const lng = ("<%= listing.lng != null ? listing.lng : 78.9629 %>");

                  const map = L.map('map').setView([lat, lng], 12);

                  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                  }).addTo(map);

                  L.marker([lat, lng])
                    .addTo(map)
                    .bindPopup("<%= listing.location || 'Location' %>")
                    .openPopup();
                </script>